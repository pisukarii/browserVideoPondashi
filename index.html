<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Visual Cue Stack Player</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #333; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .sidebar { width: 350px; background: #252525; padding: 20px; border-right: 1px solid #444; overflow-y: auto; }
        .input-group { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .input-group h3 { margin-top: 0; font-size: 14px; color: #aaa; text-transform: uppercase; }
        label { display: block; margin-bottom: 5px; font-size: 12px; }
        input[type="text"], input[type="file"] { width: 100%; margin-bottom: 10px; background: #111; border: 1px solid #555; color: white; padding: 5px; box-sizing: border-box; }
        
        /* Cueãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .content { flex: 1; padding: 20px; overflow-y: auto; background: #111; }
        .go-area { margin-bottom: 20px; }
        .btn-go { background: #d32f2f; color: white; border: none; padding: 15px 40px; font-size: 24px; font-weight: bold; border-radius: 4px; cursor: pointer; width: 100%; box-shadow: 0 4px #8b0000; }
        .btn-go:active { box-shadow: 0 0; transform: translateY(4px); }
        
        table { width: 100%; border-collapse: collapse; background: #222; }
        th, td { border: 1px solid #333; padding: 12px; text-align: left; }
        th { background: #444; font-size: 12px; }
        .cue-row { cursor: pointer; }
        .cue-row:hover { background: #2c2c2c; }
        .cue-row.active { background: #1b5e20; border-left: 5px solid #4caf50; }
        
        button { cursor: pointer; padding: 5px 10px; border-radius: 3px; border: 1px solid #555; background: #444; color: white; }
        button:hover { background: #555; }
        .btn-blue { background: #0277bd; border: none; }
        .btn-save { background: #2e7d32; border: none; }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight: bold; font-size: 1.2em;">ğŸ¥ BROWSER CUE STACK</div>
        <div>
            <button class="btn-blue" onclick="openDisplay()">1. è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•</button>
            <button class="btn-save" onclick="saveToLocalStorage()">è¨­å®šã‚’ä¿å­˜</button>
            <button onclick="loadFromLocalStorage()">è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="input-group">
                <h3>Cueç™»éŒ²</h3>
                <label>åå‰</label>
                <input type="text" id="cueName" placeholder="ä¾‹: OPãƒ ãƒ¼ãƒ“ãƒ¼">
                
                <label>YouTube URL ã¾ãŸã¯ ç”»åƒURL</label>
                <input type="text" id="cueUrl" placeholder="https://www.youtube.com/watch?v=...">
                
                <label>ã¾ãŸã¯ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                <input type="file" id="fileInput" accept="video/*,image/*">
                
                <button style="width:100%; margin-top:10px;" onclick="addCue()">Cueãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            </div>
            <p style="font-size: 11px; color: #888;">â€»YouTubeã¯åŸ‹ã‚è¾¼ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹å‹•ç”»ã®ã¿å†ç”Ÿå¯èƒ½ã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªã«ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div class="content">
            <div class="go-area">
                <button class="btn-go" onclick="fireNext()">GO / NEXT</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="40">No</th>
                        <th>NAME</th>
                        <th>TYPE</th>
                        <th width="150">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="cueList"></tbody>
            </table>
        </div>
    </div>

    <script>
        let displayWindow = null;
        let cues = [];
        let currentIndex = -1;

        // è¡¨ç¤ºç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®HTMLæ§‹é€ ã‚’Blobã§ä½œæˆã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã‚’å›é¿
        function openDisplay() {
            const displayHtml = `
                <html>
                <head>
                    <title>DISPLAY OUT</title>
                    <style>
                        body { margin:0; background:#000; overflow:hidden; display:flex; align-items:center; justify-content:center; width:100vw; height:100vh; }
                        #viewer { width:100%; height:100%; object-fit: contain; display: flex; align-items: center; justify-content: center; }
                        iframe, video, img { width:100%; height:100%; border:none; object-fit: contain; }
                    </style>
                </head>
                <body><div id="viewer"></div></body>
                </html>
            `;
            const blob = new Blob([displayHtml], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            displayWindow = window.open(url, "DisplayOut", "width=1280,height=720");
        }

        // Cueè¿½åŠ 
        async function addCue() {
            const name = document.getElementById('cueName').value || "No Name";
            const urlInput = document.getElementById('cueUrl').value;
            const fileInput = document.getElementById('fileInput');
            let finalUrl = urlInput;
            let type = "URL";

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                finalUrl = await toBase64(file); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã®ãŸã‚ã«Base64åŒ–
                type = file.type.includes('video') ? "Video" : "Image";
            } else if (urlInput.includes("youtube.com") || urlInput.includes("youtu.be")) {
                type = "YouTube";
                finalUrl = formatYouTubeUrl(urlInput);
            }

            cues.push({ name, url: finalUrl, type });
            render();
            
            // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('cueName').value = "";
            document.getElementById('cueUrl').value = "";
            document.getElementById('fileInput').value = "";
        }

        function formatYouTubeUrl(url) {
            let id = "";
            if(url.includes("v=")) id = url.split("v=")[1].split("&")[0];
            else if(url.includes("youtu.be/")) id = url.split("youtu.be/")[1];
            return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // æç”»
        function render() {
            const tbody = document.getElementById('cueList');
            tbody.innerHTML = "";
            cues.forEach((cue, i) => {
                const tr = document.createElement('tr');
                tr.className = `cue-row ${i === currentIndex ? 'active' : ''}`;
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${cue.name}</td>
                    <td><small>${cue.type}</small></td>
                    <td>
                        <button onclick="move(${i}, -1)">â†‘</button>
                        <button onclick="move(${i}, 1)">â†“</button>
                        <button style="color:#ff4444" onclick="remove(${i})">Ã—</button>
                        <button onclick="fire(${i})">SELECT</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // é€å‡ºå®Ÿè¡Œ
        function fire(index) {
            if (!displayWindow || displayWindow.closed) {
                alert("è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œ1. è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            currentIndex = index;
            const cue = cues[index];
            const viewer = displayWindow.document.getElementById('viewer');
            
            if (cue.type === "YouTube") {
                viewer.innerHTML = `<iframe src="${cue.url}" allow="autoplay; encrypted-media; fullscreen"></iframe>`;
            } else if (cue.type === "Video") {
                viewer.innerHTML = `<video src="${cue.url}" autoplay controls style="width:100%"></video>`;
            } else {
                viewer.innerHTML = `<img src="${cue.url}">`;
            }
            render();
        }

        function fireNext() {
            if (currentIndex < cues.length - 1) {
                fire(currentIndex + 1);
            }
        }

        function move(index, dir) {
            let target = index + dir;
            if (target < 0 || target >= cues.length) return;
            [cues[index], cues[target]] = [cues[target], cues[index]];
            render();
        }

        function remove(index) {
            cues.splice(index, 1);
            render();
        }

        // ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ (Local Storage)
        function saveToLocalStorage() {
            try {
                localStorage.setItem('pondashi_cues', JSON.stringify(cues));
                alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
            } catch (e) {
                alert("å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã§ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã§ä¿å­˜ã™ã‚‹ã¨å®¹é‡ã‚’æ¿€ã—ãæ¶ˆè²»ã—ã¾ã™ã€‚å¤–éƒ¨URLæ¨å¥¨ã§ã™ã€‚");
            }
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('pondashi_cues');
            if (data) {
                cues = JSON.parse(data);
                render();
            }
        }
    </script>
</body>
</html>
