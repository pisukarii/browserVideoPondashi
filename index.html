<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Fixed Cue Stack Player</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #333; padding: 10px; display: flex; gap: 10px; border-bottom: 2px solid #444; }
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; padding: 20px; background: #252525; border-right: 1px solid #444; }
        .cue-list { flex: 1; padding: 20px; overflow-y: auto; background: #111; }
        .go-btn { background: #e53935; color: white; border: none; padding: 20px; width: 100%; font-size: 30px; font-weight: bold; cursor: pointer; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 5px #b71c1c; }
        .go-btn:active { transform: translateY(3px); box-shadow: 0 2px #b71c1c; }
        input, button { padding: 10px; width: 100%; box-sizing: border-box; margin-top: 5px; border-radius: 4px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        .active { background: #2e7d32 !important; }
        .type-badge { font-size: 10px; padding: 2px 5px; background: #555; border-radius: 3px; }
    </style>
</head>
<body>

<div class="header">
    <button onclick="openDisplay()" style="width:auto; background:#0277bd; color:white;">1. 表示画面を起動</button>
    <button onclick="saveList()" style="width:auto; background:#2e7d32; color:white;">設定を保存</button>
    <button onclick="loadList()" style="width:auto;">保存から復元</button>
</div>

<div class="main">
    <div class="sidebar">
        <h3>Cue追加</h3>
        <label>名前</label>
        <input type="text" id="name" placeholder="例：オープニング">
        <label style="margin-top:10px; display:block;">YouTube URL</label>
        <input type="text" id="url" placeholder="https://www.youtube.com/...">
        <label style="margin-top:10px; display:block;">または ローカルファイル</label>
        <input type="file" id="file" accept="video/*,image/*">
        <button onclick="addCue()" style="background:#444; color:white; margin-top:15px;">リストに追加</button>
    </div>

    <div class="cue-list">
        <button class="go-btn" onclick="fireNext()">GO / NEXT</button>
        <table>
            <thead>
                <tr><th>No</th><th>Name</th><th>Type</th><th>Control</th></tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
</div>

<script>
let displayWindow = null;
let cues = [];
let currentIndex = -1;

function openDisplay() {
    displayWindow = window.open("", "DisplayWindow", "width=1280,height=720");
    if (displayWindow) {
        displayWindow.document.write(`
            <style>body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;}</style>
            <div id="screen" style="width:100%;height:100%;"></div>
        `);
    } else {
        alert("ポップアップがブロックされました！許可してください。");
    }
}

function addCue() {
    const nameInput = document.getElementById('name');
    const urlInput = document.getElementById('url');
    const fileInput = document.getElementById('file');
    
    let cue = { name: nameInput.value || "No Name", type: "", src: "" };

    if (fileInput.files.length > 0) {
        cue.type = fileInput.files[0].type.startsWith('video') ? "video" : "image";
        cue.src = URL.createObjectURL(fileInput.files[0]); // メモリ内URL
    } else if (urlInput.value.includes("youtube") || urlInput.value.includes("youtu.be")) {
        cue.type = "youtube";
        let vid = "";
        if(urlInput.value.includes("v=")) vid = urlInput.value.split("v=")[1].split("&")[0];
        else vid = urlInput.value.split("/").pop();
        cue.src = `https://www.youtube.com/embed/${vid}?autoplay=1&rel=0&enablejsapi=1`;
    } else {
        cue.type = "image";
        cue.src = urlInput.value;
    }

    cues.push(cue);
    render();
    urlInput.value = ""; nameInput.value = ""; fileInput.value = "";
}

function render() {
    const body = document.getElementById('listBody');
    body.innerHTML = "";
    cues.forEach((c, i) => {
        const tr = document.createElement('tr');
        if (i === currentIndex) tr.className = "active";
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${c.name}</td>
            <td><span class="type-badge">${c.type}</span></td>
            <td>
                <button onclick="move(${i},-1)" style="width:auto">↑</button>
                <button onclick="move(${i},1)" style="width:auto">↓</button>
                <button onclick="remove(${i})" style="width:auto; color:red;">×</button>
                <button onclick="fire(${i})" style="width:auto">SELECT</button>
            </td>
        `;
        body.appendChild(tr);
    });
}

function fire(index) {
    if (!displayWindow || displayWindow.closed) return alert("表示画面が開いていません");
    currentIndex = index;
    const cue = cues[index];
    const screen = displayWindow.document.getElementById('screen');
    
    if (cue.type === "youtube") {
        screen.innerHTML = `<iframe src="${cue.src}" style="width:100%;height:100%;border:none;" allow="autoplay; fullscreen"></iframe>`;
    } else if (cue.type === "video") {
        screen.innerHTML = `<video src="${cue.src}" autoplay controls style="width:100%;height:100%;"></video>`;
    } else {
        screen.innerHTML = `<img src="${cue.src}" style="width:100%;height:100%;object-fit:contain;">`;
    }
    render();
}

function fireNext() {
    if (currentIndex < cues.length - 1) fire(currentIndex + 1);
}

function move(i, d) {
    if (i+d < 0 || i+d >= cues.length) return;
    [cues[i], cues[i+d]] = [cues[i+d], cues[i]];
    render();
}

function remove(i) { cues.splice(i, 1); render(); }

// ファイルそのものは保存せず、リスト構造だけ保存（エラー153対策）
function saveList() {
    const data = cues.map(c => ({ name: c.name, type: c.type === 'youtube' ? 'youtube' : 'url', src: c.type === 'youtube' ? c.src : "" }));
    localStorage.setItem('pondashi_data', JSON.stringify(data));
    alert("リストの並びを保存しました（※ローカル動画ファイル自体は再起動時に再選択が必要です）");
}

function loadList() {
    const data = localStorage.getItem('pondashi_data');
    if (data) { cues = JSON.parse(data); render(); }
}
</script>
</body>
</html>
